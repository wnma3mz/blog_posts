---
title: Python 获取小米温湿度计的数据
date: 2023-11-26 21:40:24
tags: [IOT, 树莓派, Python]
categories: [笔记]
---

使用 Python 获取小米温湿度计的数据

<!-- more -->

## 需求

小米温湿度计用米家连接速度慢，且获取间隔为 1 小时一次，感觉有点慢，想要手动保存这些数据。

本来是想使用 HomeAssistant 来完成的，但发现 Python 版本要求 3.8 以上，而树莓派上的 Python 版本是 3.7。且就这一个设备，感觉没必要那么复杂。

好在已经有成熟的开源项目实现这一功能，https://github.com/JsBergbau/MiTemperature2。使用起来也很简单

## 准备

安装蓝牙驱动

```bash
# 可以先输入 bluetoothctl 看看是否可以进入蓝牙交互界面，如果可以则无需安装
sudo apt update -y && sudo apt upgrade -y 
sudo apt install bluetooth pi-bluetooth bluez blueman mplayer -y
```

python 安装依赖
```
pip3 install bluepy
```

## 获取设备信息

```bash
# 进入蓝牙交互界面
bluetoothctl

# 扫描附件的蓝牙设备
scan on
```

会持续扫描附近蓝牙设备，需要关注一个叫做 LYWSD03MMC 的设备（在设备后面有型号），这个就是小米温湿度计。

```bash
...
[NEW] Device AA:BB:CC:DD:EE:FF LYWSD03MMC
...
```

记录这个设备的 MAC 地址，退出蓝牙交互界面

```bash
exit
```

## 实现

原来的代码过于复杂，还涉及一些其他的功能。核心功能是，获取温湿度信息即可。因此，我对代码进行了简化。在外面套一个定时任务即可。

把 MAC 地址写到下面的脚本中，然后运行脚本，就可以获取到温湿度信息了。

<script src="https://gist.github.com/wnma3mz/197a5665734e2449e591892da10cd08f.js"></script>

每 10 分钟获取一次温湿度信息，保存到 `temp.log` 文件中。如果每次获取失败次数超过 5 次，则退出程序。

```bash
*/10 * * * * cd /root/MiTemperature2 && /usr/bin/python3 mi_temp.py >> /root/MiTemperature2/temp.log
```

下面的脚本可以获取树莓派本身的温度信息，保存到 `temp.log` 文件中。可以进行对比
```bash
#!/bin/bash
echo `date +"%Y-%m-%d %H:%M"` `vcgencmd measure_temp` >> /home/pi/temp_save/temp.log
```

参考

[1] https://www.cnblogs.com/blueberry-mint/p/16575252.html

[2] https://github.com/JsBergbau/MiTemperature2

